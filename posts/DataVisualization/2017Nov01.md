---
layout: default
title: 
permalink: /posts/DataVisualization/2017Nov01
---

## Interactive Data Visualization with Geographical Coordinates using Bokeh
333
As a data enthusiastic, sometimes the data we analyzed contains information related to specific places. For example, the crime rate in every State in the United States. In this situation, it would be easier for us to convey the interesting messages we have found from a data to our readers using a geographical map. Practically, a static graph of data on a map is enough to do this job. However, an interactive figure would be even more appealing and informative to our readers! 

Although there are many free geographical maps API (e.g. OpenStreetMap) and maps with limited data usage (Google Maps API) available, it is not easy to combine or overlay our findings on these maps, especially when we want to create an interactive graph with a map. In this post, we will use [Bokeh](https://bokeh.pydata.org/en/latest/) to draw an interactive figure without using any of these maps mentioned. What we need here are the coordinates (a set of longitude and latitude) of the boundary of a place or a city. 

The datasets we used here can be found at [] and []. 

### Draw a map using longitude and latitude
The first thing is to manipulate the longitude and latitude and rearrange them in a way that Bokeh favors.

```python
# import library
import numpy as np
import pandas as pd

from bokeh.plotting import figure
from bokeh.io import output_file, show
from bokeh.models import ColumnDataSource, HoverTool, LogColorMapper
from bokeh.palettes import RdYlBu5
```

``` python
# read geographical data
df = pd.read_csv('geo_bounary_NC.csv')

# make a copy and extract interested columns
geo = df.copy()[['County Name', 'geometry']]

# extract a set of longitude (x) and latitude (y)
geo['x'] = geo.apply(lambda row: [float(i.split(',')[0]) for i in row.geometry[51:-55].split(' ')], axis=1)
geo['y'] = geo.apply(lambda row: [float(i.split(',')[1]) for i in row.geometry[51:-55].split(' ')], axis=1)

# rename and extract interested the column
geo.columns = ['County', 'geometry', 'x', 'y']
geo = geo[['County', 'x', 'y']]

# take a look
geo.head()
```

![](/2017Nov01.png "geo.head()")

At this point, we have the data format for drawing a map using Bokeh. To be specific, for county, **Alamance**, we have the corresponding longtitude `[-79.54207, -79.54208, -79.54203, -79.54201, ...` and latitude `[35.88714, 35.8894, 35.8936, 35.89584, 35.8996...`. With these information, we are able to draw an interactive map already with the following code.

```python
# create ColumnDataSource
source = ColumnDataSource(geo)

# hover tool
hover = HoverTool(tooltips= [('County Name', '@County'),
                             ('(Long, Lat)', '($x, $y)')],
                  mode='mouse')

# create a figure
p = figure(title="Counties in North Carolina", tools=[hover, 'reset', 'save'],
           x_axis_location=None, y_axis_location=None, plot_width=900, plot_height=400)

# remove grids
p.grid.grid_line_color = None

# plot boundary
p.patches('x', 'y', source=source, line_color='black', line_width=0.8, fill_alpha=0.4)

# output html file and show it
output_file('county_NC.html')
show(p)
```

<div class="row">
  <div class="col-lg-1">
  </div>
  <div class="col-lg">
    {% include county_NC.html %}
  </div>
  <div class="col-lg-1">
  </div>
</div>

We can do more than that! Now we try to merge another dataset from xxx and make our graph more attractive and informative.

```
# read cattle data and extracted interested columns
df = pd.read_csv('cattle_sell_NC_2012.csv')[['Year', 'County', 'Data Item', 'Domain', 'Domain Category', 'Value']]

# copy original df
cattle = df.copy()

# specify missing values and remove them
cattle.Value = cattle.Value.str.lstrip().replace('(D)', np.nan)
cattle = cattle.dropna(axis=0)

# convert str to float in 'Value' column
cattle.Value = cattle.Value.apply(lambda row: np.int(''.join(row.split(','))))

# convert county name to 'title' from 'uppercase'
cattle.County = cattle.County.str.title()

# deal with counties who have multiple values in $
cattle = cattle.groupby(['County'])[['Value']].sum()

# merge geo data and cattle sell
nc = pd.merge(geo, cattle, left_on='County', right_index=True, how='left')

# take a look
nc.head()
```

![](/figure/2017Nov01_head_nc.png "nc.head()")

Make a plot!!

```python
RdYlBu5.reverse()
mapper = LogColorMapper(palette=RdYlBu5)

source = ColumnDataSource(nc)

# hover tool
hover = HoverTool(tooltips= [("County Name", "@County"),
                             ('Cattle Sold', '$@Value')],
                  mode='mouse')

p = figure(title="Cattle Sold in 2012 in North Carolina", tools=[hover, 'reset', 'save'],
           x_axis_location=None, y_axis_location=None, plot_width=700, plot_height=300)

p.grid.grid_line_color = None

p.patches('x', 'y', source=source,
          line_color="black", line_width=0.8,
          fill_alpha=0.4, fill_color={'field': 'Value', 'transform': mapper},)

output_file('cattle_sold_NC_2012.html')
show(p)
```

<div class="row">
  <div class="col-lg-1">
  </div>
  <div class="col-lg-auto">
    {% include cattle_sold_NC_2012.html %}
  </div>
  <div class="col-lg-1">
  </div>
</div>

The above interactive graph is the cattle sold in $ for parts of counties in North Carolina, USA in 2012. 
