---
layout: default
title: Interactive Data Visualization with Geographical Coordinates using Bokeh
permalink: /posts/DataVisualization/2017Nov01
---

## Interactive Data Visualization with Geographical Coordinates using Bokeh
### Motivation
As a data enthusiastic, occasionally the data we analyzed contains information related to specific places. For example, the crime rate in every State in the United States. In this situation, it would be easier for us to convey the interesting messages we have found to our readers using a geographical map. 

Practically, a static plot of data on a map is good enough to do this job. However, an interactive graph would be even more appealing and informative to our readers! 

Although there are many free map API (e.g. [OpenStreetMap](https://www.openstreetmap.org)) and maps with limited data usage (e.g. [Google Maps API](https://developers.google.com/maps/)) available, it is not a simple task to combine or overlay our findings on these geographical maps, especially when we want to create an interactive graph! 

In this post, we will use Python with [Bokeh](https://bokeh.pydata.org/en/latest/) to draw an interactive figure without using any of geographical map APIs. Instead, what we need here are the coordinates (a set of longitude and latitude) of the boundary of a place or a city.

### Download the data
The *original* datasets we used here can be found at [Here](https://fusiontables.google.com/DataSource?docid=1Ewx86_38dldGMt-fSKjBELX_VF7kuVz8cbXQ0A#rows:id=1) and [Here](https://quickstats.nass.usda.gov/). The detailed code and data we used can be found [Here](https://github.com/thsieh4/thsieh4.github.io/tree/master/code/2017Nov01).

### Draw a map based on longitude and latitude
Already having the data with coordinates at hand? Now the first thing is to import the necessary libraries.

```python
# import library
import numpy as np
import pandas as pd

from bokeh.plotting import figure
from bokeh.io import output_file, show
from bokeh.models import ColumnDataSource, HoverTool, LogColorMapper
from bokeh.palettes import RdYlBu5
```

Now let's load the data and take a quick look.

``` python
# read geographical data
df = pd.read_csv('geo_bounary_NC.csv')
df.head()
```

![](/figure/2017Nov01_df_head.png "df.head()")

The data we are interested in are the columns **County Name** and **geometry**. The column **geometry** has the boundary information of a **County**. Now, let's manipulate the **geometry** (**longitude** and **latitude**) a little bit and rearrange them in a way that Bokeh favors.

``` python
# make a copy and extract interested columns
geo = df.copy()[['County Name', 'geometry']]

# extract a set of longitude (x) and latitude (y)
geo['x'] = geo.apply(lambda row: [float(i.split(',')[0]) for i in row.geometry[51:-55].split(' ')], axis=1)
geo['y'] = geo.apply(lambda row: [float(i.split(',')[1]) for i in row.geometry[51:-55].split(' ')], axis=1)

# rename and extract interested the column
geo.columns = ['County', 'geometry', 'x', 'y']
geo = geo[['County', 'x', 'y']]

# take a look
geo.head()
```

![](/figure/2017Nov01_head_geo.png "geo.head()")

After a series of data cleaning (more [detailed code](https://github.com/thsieh4/thsieh4.github.io/blob/master/code/2017Nov01/InteractiveDataVisualizationWithGeographicalCoordinatesUsingBokeh.ipynb)), at this point, we have the desired data format for drawing a map using Bokeh.

Specifically, for county **Alamance** (first row), we have
- longtitude `[-79.54207, -79.54208, -79.54203, -79.54201, ...` and
- latitude `[35.88714, 35.8894, 35.8936, 35.89584, 35.8996...`

in **x** and **y** columns, respectively. These are the boundary of **Alamance**.

With these information, we are ready to draw an interactive map with the following code.

```python
# create ColumnDataSource
source = ColumnDataSource(geo)

# hover tool
hover = HoverTool(tooltips= [('County Name', '@County'),
                             ('(Long, Lat)', '($x, $y)')],
                  mode='mouse')

# create a figure
p = figure(title="Counties in North Carolina", tools=[hover, 'reset', 'save'],
           x_axis_location=None, y_axis_location=None, plot_width=900, plot_height=400)

# remove grids
p.grid.grid_line_color = None

# plot boundary
p.patches('x', 'y', source=source, line_color='black', line_width=0.8, fill_alpha=0.4)

# output html file and show it
output_file('county_NC.html')
show(p)
```

<div class="row">
  <div class="col-lg-1">
  </div>
  <div class="col-lg">
    {% include county_NC.html %}
  </div>
  <div class="col-lg-1">
  </div>
</div>

Now, you can move your mouse cursor on the graph. It will tell you which county and the coordiantes you are pointed at in real time!!

### Add more imformation
Of course we can do more than that! Let's try to merge another dataset (the *cattle sold in USD*) and make our graph more attractive and informative.

```
# read cattle data 
df = pd.read_csv('cattle_sold_NC_2012.csv')

# extracted interested columns
df = df[['Year', 'County', 'Data Item', 'Domain Category', 'Value']]

# copy original df
cattle = df.copy()

# specify missing values and remove them
cattle.Value = cattle.Value.str.lstrip().replace('(D)', np.nan)
cattle = cattle.dropna(axis=0)

# convert str to float in 'Value' column
cattle.Value = cattle.Value.apply(lambda row: np.int(''.join(row.split(','))))

# convert county name to 'title' from 'uppercase'
cattle.County = cattle.County.str.title()

# deal with counties who have multiple values in $
cattle = cattle.groupby(['County'])[['Value']].sum()

# merge geo data and cattle sell
nc = pd.merge(geo, cattle, left_on='County', right_index=True, how='left')

# take a look
nc.head()
```

![](/figure/2017Nov01_head_nc.png "nc.head()")

We have one additional column **Value**. This is the cattle sold in each county in the unit of USD. Now let's make a plot of this new data!!

```python
RdYlBu5.reverse()
mapper = LogColorMapper(palette=RdYlBu5)

source = ColumnDataSource(nc)

# hover tool
hover = HoverTool(tooltips= [("County Name", "@County"),
                             ('Cattle Sold', '$@Value')],
                  mode='mouse')

p = figure(title="Cattle Sold in 2012 in North Carolina", tools=[hover, 'reset', 'save'],
           x_axis_location=None, y_axis_location=None, plot_width=700, plot_height=300)

p.grid.grid_line_color = None

p.patches('x', 'y', source=source,
          line_color="black", line_width=0.8,
          fill_alpha=0.4, fill_color={'field': 'Value', 'transform': mapper},)

output_file('cattle_sold_NC_2012.html')
show(p)
```

<div class="row">
  <div class="col-lg-1">
  </div>
  <div class="col-lg-auto">
    {% include cattle_sold_NC_2012.html %}
  </div>
  <div class="col-lg-1">
  </div>
</div>

The above interactive map shows the cattle sold in $USD for counties in North Carolina, USA in 2012. Notice that missing values are colored in gray.
